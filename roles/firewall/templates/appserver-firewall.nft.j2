#!/usr/bin/nft -f

flush ruleset

table inet TinyWall  {
    chain input {
        type filter hook input priority 0; policy drop;

        ip protocol icmp icmp type echo-request limit rate 4/second accept
        ip protocol icmp icmp type echo-request counter drop
        ip6 nexthdr icmpv6 icmpv6 type echo-request limit rate 4/second accept
        ip6 nexthdr icmpv6 icmpv6 type echo-request counter drop

        ct state related,established accept
        ct state invalid drop

        iifname "lo" accept

        ip protocol icmp icmp type { destination-unreachable, router-advertisement, time-exceeded, parameter-problem } accept
        ip6 nexthdr icmpv6 icmpv6 type { destination-unreachable, packet-too-big, time-exceeded, parameter-problem, echo-reply, nd-router-advert, nd-neighbor-solicit, nd-neighbor-advert } accept

        tcp dport ssh accept comment "SSH port 22"
        tcp dport 19999 ip saddr {{ gateway_address }} accept comment "Netdata"
        tcp dport http-alt ip saddr {{ gateway_address }} accept comment "webhook-server"
        tcp dport 5432 ip saddr {{ project_subnet }}/24 accept comment "Postgres"
    }

    chain output {
        type filter hook output priority 0; policy accept;
    }

    chain forward {
        type filter hook forward priority 0; policy drop;
    }
}
